<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ ãƒ‡ãƒ¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .character-container {
            position: relative;
            width: 400px;
            height: 400px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .character-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.05s ease;
        }

        .character-img.closed {
            z-index: 2;
        }

        .character-img.open {
            z-index: 1;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 500px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .audio-select {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-select label {
            font-weight: bold;
        }

        .audio-select select {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: #fff;
            cursor: pointer;
        }

        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .play-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }

        .mic-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .mic-btn.recording {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(232, 67, 147, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(232, 67, 147, 0); }
        }

        .visualizer {
            width: 100%;
            height: 60px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .visualizer canvas {
            width: 100%;
            height: 100%;
        }

        .volume-meter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-bar {
            flex: 1;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #fdcb6e, #e17055);
            width: 0%;
            transition: width 0.05s ease;
            border-radius: 10px;
        }

        .info {
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .method-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
        }

        .method-info h3 {
            margin-bottom: 10px;
            color: #00cec9;
        }
    </style>
</head>
<body>
    <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ ãƒ‡ãƒ¢</h1>

    <div class="container">
        <div class="character-container">
            <img id="imgClosed" class="character-img closed" src="characters/kazuo_expressions/kazuo_general_05_neutral.png" alt="å£é–‰ã˜">
            <img id="imgOpen" class="character-img open" src="characters/kazuo_expressions/kazuo_general_03_surprised.png" alt="å£é–‹ã">
        </div>

        <div class="controls">
            <div class="audio-select">
                <label>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <select id="audioSelect">
                    <option value="audio/s02_04.mp3">s02_04 - ä¸€ç”·ã®ã‚»ãƒªãƒ•</option>
                    <option value="audio/s02_06.mp3">s02_06 - ä¸€ç”·ã®ã‚»ãƒªãƒ•</option>
                    <option value="audio/s03_01.mp3">s03_01 - ä¸€ç”·ã®ã‚»ãƒªãƒ•</option>
                    <option value="audio/s03_03.mp3">s03_03 - ä¸€ç”·ã®ã‚»ãƒªãƒ•</option>
                    <option value="audio/s03_05.mp3">s03_05 - ä¸€ç”·ã®ã‚»ãƒªãƒ•</option>
                </select>
            </div>

            <div class="volume-meter">
                <span>éŸ³é‡:</span>
                <div class="volume-bar">
                    <div id="volumeFill" class="volume-fill"></div>
                </div>
                <span id="volumeValue">0%</span>
            </div>

            <div class="visualizer">
                <canvas id="visualizer"></canvas>
            </div>

            <div class="buttons">
                <button id="playBtn" class="play-btn">â–¶ å†ç”Ÿ</button>
                <button id="stopBtn" class="stop-btn">â–  åœæ­¢</button>
                <button id="micBtn" class="mic-btn">ğŸ¤ ãƒã‚¤ã‚¯å…¥åŠ›</button>
            </div>
        </div>

        <div class="method-info">
            <h3>ä»•çµ„ã¿</h3>
            <p>Web Audio API ã§éŸ³å£°ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆæŒ¯å¹…ï¼‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è§£æã—ã€<br>
            éŸ³é‡ã«å¿œã˜ã¦ã€Œå£é–‰ã˜ã€ã¨ã€Œå£é–‹ãã€ã®ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™ã€‚<br>
            å‡¦ç†ã¯å®Œå…¨ã«ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã€é…å»¶ã¯ã»ã¼ã‚¼ãƒ­ã§ã™ã€‚</p>
        </div>

        <div class="info">
            <p>â€» å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚ˆã‚Šå¤šãã®å£å½¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚/ã„/ã†/ãˆ/ãŠï¼‰ã‚’ç”¨æ„ã—ã€<br>
            éŸ³ç´ è§£æï¼ˆRhubarb Lip Syncç­‰ï¼‰ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚</p>
        </div>
    </div>

    <script>
        // è¦ç´ å–å¾—
        const imgClosed = document.getElementById('imgClosed');
        const imgOpen = document.getElementById('imgOpen');
        const audioSelect = document.getElementById('audioSelect');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const micBtn = document.getElementById('micBtn');
        const volumeFill = document.getElementById('volumeFill');
        const volumeValue = document.getElementById('volumeValue');
        const visualizerCanvas = document.getElementById('visualizer');
        const canvasCtx = visualizerCanvas.getContext('2d');

        // Audio Context
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let audioSource = null;
        let audioElement = null;
        let micStream = null;
        let animationId = null;
        let isPlaying = false;
        let isMicActive = false;

        // é–¾å€¤è¨­å®š
        const THRESHOLD = 15; // ã“ã®å€¤ä»¥ä¸Šã§å£ã‚’é–‹ã
        const SMOOTHING = 0.8; // 0-1, é«˜ã„ã»ã©æ»‘ã‚‰ã‹

        // åˆæœŸåŒ–
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = SMOOTHING;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
        }

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ
        async function playAudio() {
            initAudio();

            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // æ—¢å­˜ã®å†ç”Ÿã‚’åœæ­¢
            stopAudio();

            // Audioè¦ç´ ã‚’ä½œæˆ
            audioElement = new Audio(audioSelect.value);
            audioElement.crossOrigin = 'anonymous';

            // Audio Contextã«æ¥ç¶š
            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);

            // å†ç”Ÿ
            audioElement.play();
            isPlaying = true;

            // çµ‚äº†æ™‚ã®å‡¦ç†
            audioElement.onended = () => {
                isPlaying = false;
                imgClosed.style.opacity = 1;
            };

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            animate();
        }

        // åœæ­¢
        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
                audioElement = null;
            }
            if (audioSource) {
                audioSource.disconnect();
                audioSource = null;
            }
            isPlaying = false;
            imgClosed.style.opacity = 1;
        }

        // ãƒã‚¤ã‚¯å…¥åŠ›
        async function toggleMic() {
            initAudio();

            if (isMicActive) {
                // ãƒã‚¤ã‚¯åœæ­¢
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                }
                isMicActive = false;
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ğŸ¤ ãƒã‚¤ã‚¯å…¥åŠ›';
                imgClosed.style.opacity = 1;
                return;
            }

            try {
                // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å–å¾—
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // ãƒã‚¤ã‚¯ã‚’Analyserã«æ¥ç¶š
                const micSource = audioContext.createMediaStreamSource(micStream);
                micSource.connect(analyser);
                // æ³¨: ãƒã‚¤ã‚¯å…¥åŠ›ã¯ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã«å‡ºåŠ›ã—ãªã„ï¼ˆãƒã‚¦ãƒªãƒ³ã‚°é˜²æ­¢ï¼‰

                isMicActive = true;
                micBtn.classList.add('recording');
                micBtn.textContent = 'ğŸ”´ åœæ­¢';

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
                animate();

            } catch (err) {
                console.error('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            if (!isPlaying && !isMicActive) {
                return;
            }

            animationId = requestAnimationFrame(animate);

            // å‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿å–å¾—
            analyser.getByteFrequencyData(dataArray);

            // å¹³å‡éŸ³é‡ã‚’è¨ˆç®—
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;

            // éŸ³é‡ã«å¿œã˜ã¦å£ã®é–‹ãå…·åˆã‚’åˆ¶å¾¡
            const volumePercent = Math.min(100, (average / 128) * 100);
            volumeFill.style.width = volumePercent + '%';
            volumeValue.textContent = Math.round(volumePercent) + '%';

            // é–¾å€¤ã‚’è¶…ãˆãŸã‚‰å£ã‚’é–‹ã
            if (average > THRESHOLD) {
                // éŸ³é‡ã«å¿œã˜ã¦é€æ˜åº¦ã‚’èª¿æ•´ï¼ˆæ»‘ã‚‰ã‹ãªåˆ‡ã‚Šæ›¿ãˆï¼‰
                const openAmount = Math.min(1, (average - THRESHOLD) / 50);
                imgClosed.style.opacity = 1 - openAmount;
            } else {
                imgClosed.style.opacity = 1;
            }

            // æ³¢å½¢ã‚’æç”»
            drawVisualizer();
        }

        // æ³¢å½¢æç”»
        function drawVisualizer() {
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;

            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            canvasCtx.fillRect(0, 0, width, height);

            const barWidth = (width / dataArray.length) * 2.5;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * height;

                // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è‰²
                const hue = (i / dataArray.length) * 120 + 120; // ç·‘ã€œé’
                canvasCtx.fillStyle = `hsl(${hue}, 70%, 50%)`;

                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        // Canvas ã‚µã‚¤ã‚ºèª¿æ•´
        function resizeCanvas() {
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        playBtn.addEventListener('click', playAudio);
        stopBtn.addEventListener('click', stopAudio);
        micBtn.addEventListener('click', toggleMic);
        window.addEventListener('resize', resizeCanvas);

        // åˆæœŸåŒ–
        resizeCanvas();
    </script>
</body>
</html>

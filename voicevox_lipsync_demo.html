<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOICEVOX + リアルタイム リップシンク デモ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        h1 {
            margin-bottom: 10px;
            font-size: 24px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .subtitle {
            margin-bottom: 20px;
            opacity: 0.7;
            font-size: 14px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 900px;
            width: 100%;
        }

        .main-area {
            display: flex;
            gap: 20px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .character-container {
            position: relative;
            width: 350px;
            height: 350px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .character-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.05s ease;
        }

        .character-img.closed {
            z-index: 2;
        }

        .character-img.open {
            z-index: 1;
        }

        .character-name {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10;
        }

        .chat-area {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        .message-box {
            flex: 1;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%;
        }

        .message.user {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.patient {
            background: linear-gradient(135deg, #00b894, #00cec9);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message .speaker {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
        }

        .input-area button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            transition: all 0.2s ease;
        }

        .input-area button:hover {
            transform: translateY(-2px);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            width: 100%;
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-row label {
            font-weight: bold;
            min-width: 100px;
        }

        .control-row select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            background: #fff;
            cursor: pointer;
        }

        .volume-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .volume-bar {
            flex: 1;
            height: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894, #fdcb6e, #e17055);
            width: 0%;
            transition: width 0.05s ease;
            border-radius: 8px;
        }

        .quick-phrases {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-phrase {
            padding: 8px 15px;
            font-size: 13px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.2s ease;
        }

        .quick-phrase:hover {
            background: rgba(255,255,255,0.3);
        }

        .info-box {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-box h3 {
            color: #00cec9;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>VOICEVOX + リアルタイム リップシンク</h1>
    <p class="subtitle">テキストを入力すると、患者（一男さん）が音声付きで応答します</p>

    <div class="container">
        <div class="main-area">
            <div class="character-container">
                <img id="imgClosed" class="character-img closed" src="characters/kazuo_expressions/kazuo_general_05_neutral.png" alt="口閉じ">
                <img id="imgOpen" class="character-img open" src="characters/kazuo_expressions/kazuo_general_03_surprised.png" alt="口開き">
                <div class="character-name">患者: 田中一男 (72歳)</div>
            </div>

            <div class="chat-area">
                <div class="status-bar">
                    <div id="statusIndicator" class="status-indicator"></div>
                    <span id="statusText">VOICEVOX 接続確認中...</span>
                </div>

                <div id="messageBox" class="message-box">
                    <div class="message patient">
                        <div class="speaker">田中一男</div>
                        あ、看護師さん。こんにちは。今日もよろしくお願いします。
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" id="userInput" placeholder="患者への質問を入力..." disabled>
                    <button id="sendBtn" disabled>送信</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <label>話者:</label>
                <select id="speakerSelect">
                    <option value="1">ずんだもん（あまあま）</option>
                    <option value="3">ずんだもん（ノーマル）</option>
                    <option value="2">四国めたん（ノーマル）</option>
                    <option value="8">春日部つむぎ（ノーマル）</option>
                    <option value="13" selected>青山龍星（ノーマル）- 男性</option>
                    <option value="14">冥鳴ひまり（ノーマル）</option>
                </select>
                <label>速度:</label>
                <select id="speedSelect">
                    <option value="0.8">ゆっくり</option>
                    <option value="1.0" selected>普通</option>
                    <option value="1.2">速め</option>
                </select>
            </div>

            <div class="control-row">
                <label>音量:</label>
                <div class="volume-meter">
                    <div class="volume-bar">
                        <div id="volumeFill" class="volume-fill"></div>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <label>クイック入力:</label>
                <div class="quick-phrases">
                    <button class="quick-phrase" data-text="今日の調子はいかがですか？">調子を聞く</button>
                    <button class="quick-phrase" data-text="息苦しさはありますか？">息苦しさ</button>
                    <button class="quick-phrase" data-text="お薬は飲んでいますか？">服薬確認</button>
                    <button class="quick-phrase" data-text="食欲はありますか？">食欲</button>
                    <button class="quick-phrase" data-text="夜は眠れていますか？">睡眠</button>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>患者設定（COPD教材より）</h3>
            <p>
                <strong>田中一男</strong> 72歳男性。COPD（慢性閉塞性肺疾患）の診断を受けている。<br>
                在宅酸素療法中。日常生活での息切れあり。<br>
                このデモでは、入力したテキストをそのまま患者の発話として音声合成します。<br>
                （実際のシステムでは、LLMが患者役として応答を生成します）
            </p>
        </div>
    </div>

    <script>
        // 要素取得
        const imgClosed = document.getElementById('imgClosed');
        const imgOpen = document.getElementById('imgOpen');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const messageBox = document.getElementById('messageBox');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const speakerSelect = document.getElementById('speakerSelect');
        const speedSelect = document.getElementById('speedSelect');
        const volumeFill = document.getElementById('volumeFill');
        const quickPhrases = document.querySelectorAll('.quick-phrase');

        // VOICEVOX設定
        const VOICEVOX_URL = 'http://localhost:50021';

        // Audio Context
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let isPlaying = false;

        // VOICEVOX接続確認
        async function checkVoicevox() {
            try {
                const response = await fetch(`${VOICEVOX_URL}/version`);
                if (response.ok) {
                    const version = await response.text();
                    statusIndicator.classList.add('connected');
                    statusText.textContent = `VOICEVOX 接続済み (v${version})`;
                    userInput.disabled = false;
                    sendBtn.disabled = false;
                    return true;
                }
            } catch (e) {
                console.error('VOICEVOX接続エラー:', e);
            }
            statusText.textContent = 'VOICEVOX 未接続 - アプリを起動してください';
            return false;
        }

        // 音声合成
        async function synthesize(text, speakerId, speed) {
            // 1. audio_query作成
            const queryResponse = await fetch(
                `${VOICEVOX_URL}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`,
                { method: 'POST' }
            );
            const query = await queryResponse.json();

            // 速度調整
            query.speedScale = parseFloat(speed);

            // 2. 音声合成
            const synthesisResponse = await fetch(
                `${VOICEVOX_URL}/synthesis?speaker=${speakerId}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(query)
                }
            );

            return await synthesisResponse.arrayBuffer();
        }

        // 音声再生 + リップシンク
        async function playWithLipsync(audioBuffer) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }

            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // ArrayBufferをAudioBufferに変換
            const decodedAudio = await audioContext.decodeAudioData(audioBuffer);

            // ソース作成
            const source = audioContext.createBufferSource();
            source.buffer = decodedAudio;
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            // 再生
            isPlaying = true;
            source.start();
            animate();

            source.onended = () => {
                isPlaying = false;
                imgClosed.style.opacity = 1;
                volumeFill.style.width = '0%';
            };
        }

        // リップシンクアニメーション
        function animate() {
            if (!isPlaying) return;

            requestAnimationFrame(animate);

            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;

            const volumePercent = Math.min(100, (average / 128) * 100);
            volumeFill.style.width = volumePercent + '%';

            const THRESHOLD = 15;
            if (average > THRESHOLD) {
                const openAmount = Math.min(1, (average - THRESHOLD) / 50);
                imgClosed.style.opacity = 1 - openAmount;
            } else {
                imgClosed.style.opacity = 1;
            }
        }

        // メッセージ追加
        function addMessage(text, isUser) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'patient'}`;
            div.innerHTML = `
                <div class="speaker">${isUser ? '看護師' : '田中一男'}</div>
                ${text}
            `;
            messageBox.appendChild(div);
            messageBox.scrollTop = messageBox.scrollHeight;
        }

        // 送信処理
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 入力無効化
            userInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            // ユーザーメッセージ表示（看護師の質問として）
            addMessage(text, true);
            userInput.value = '';

            try {
                // 患者の応答（デモなので同じテキストを返す）
                // 実際はここでLLMを呼び出す
                const patientResponse = generatePatientResponse(text);

                // 音声合成
                const audioBuffer = await synthesize(
                    patientResponse,
                    speakerSelect.value,
                    speedSelect.value
                );

                // 患者メッセージ表示
                addMessage(patientResponse, false);

                // 音声再生 + リップシンク
                await playWithLipsync(audioBuffer);

            } catch (e) {
                console.error('エラー:', e);
                addMessage('（音声合成エラーが発生しました）', false);
            }

            // 入力有効化
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = '送信';
            userInput.focus();
        }

        // 患者応答生成（シンプルなルールベース - 後でLLMに置き換え）
        function generatePatientResponse(nurseText) {
            const responses = {
                '調子': 'まあまあですかね。少し息が苦しいときもありますけど。',
                '息苦しさ': 'そうですね、階段を上がると息切れがしますね。平地を歩くのは大丈夫です。',
                '薬': 'はい、毎日ちゃんと飲んでいますよ。朝と夜に。',
                '食欲': '最近は食欲ありますよ。昨日は妻の作った煮物を食べました。',
                '眠れ': 'ええ、よく眠れています。酸素のおかげかもしれませんね。',
                'こんにちは': 'こんにちは。今日もよろしくお願いします。',
                'ありがとう': 'いえいえ、こちらこそありがとうございます。',
            };

            for (const [keyword, response] of Object.entries(responses)) {
                if (nurseText.includes(keyword)) {
                    return response;
                }
            }

            return 'そうですか。わかりました。';
        }

        // イベントリスナー
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });

        quickPhrases.forEach(btn => {
            btn.addEventListener('click', () => {
                userInput.value = btn.dataset.text;
                sendMessage();
            });
        });

        // 初期化
        checkVoicevox();

        // 定期的に接続確認
        setInterval(checkVoicevox, 5000);
    </script>
</body>
</html>

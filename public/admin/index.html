<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カンゴ☆デラックス - 管理画面</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }

        /* ログインセクション */
        .login-section {
            background: white;
            padding: 60px 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin: 100px auto;
            max-width: 400px;
        }
        .login-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        .login-section p {
            color: #666;
            margin-bottom: 30px;
        }
        .btn-google {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-google:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }
        .btn-google img {
            width: 24px;
            height: 24px;
        }

        /* ユーザー情報バー */
        .user-bar {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-name {
            font-weight: bold;
            color: #2c3e50;
        }
        .user-email {
            font-size: 12px;
            color: #7f8c8d;
        }
        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-logout:hover {
            background: #c0392b;
        }

        /* メインコンテンツ（ログイン後） */
        .main-content {
            display: none;
        }
        .main-content.show {
            display: block;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input[type="text"],
        input[type="url"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .url-input-group {
            display: flex;
            gap: 10px;
        }
        .url-input-group input {
            flex: 1;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-fetch {
            background-color: #9b59b6;
            color: white;
            white-space: nowrap;
        }
        .btn-fetch:hover {
            background-color: #8e44ad;
        }
        .btn-fetch:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-delete {
            background-color: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .btn-edit {
            background-color: #f39c12;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn-edit:hover {
            background-color: #d68910;
        }

        /* OGPプレビュー */
        .ogp-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        .ogp-preview.show {
            display: block;
        }
        .ogp-preview-header {
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .ogp-preview-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .ogp-preview-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
        }
        .ogp-preview-content {
            padding: 12px;
        }
        .ogp-preview-title {
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 5px;
        }
        .ogp-preview-description {
            font-size: 14px;
            color: #666;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .ogp-preview-site {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        /* 記事一覧 */
        .news-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .news-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-card {
            display: flex;
            gap: 15px;
        }
        .news-card-image {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .news-card-image.no-image {
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 12px;
        }
        .news-card-content {
            flex: 1;
        }
        .news-card-comment {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f0f7ff;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }
        .news-card-title {
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 5px;
        }
        .news-card-title a {
            color: #3498db;
            text-decoration: none;
        }
        .news-card-title a:hover {
            text-decoration: underline;
        }
        .news-card-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-meta {
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .category-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 500;
        }
        .category-digital { background: #E3F2FD; color: #1565C0; }
        .category-nursing { background: #FCE4EC; color: #C2185B; }
        .category-deluxe { background: #FFF3E0; color: #E65100; }
        .category-education { background: #E8F5E9; color: #2E7D32; }
        .category-blog { background: #F3E5F5; color: #7B1FA2; }
        .news-actions {
            margin-top: 10px;
        }
        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .filter-section {
            margin-bottom: 20px;
        }
        .filter-section select {
            width: auto;
            padding: 8px 15px;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* モーダル */
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover {
            color: #333;
        }

        /* ローディング */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .loading-overlay.hide {
            display: none;
        }
        .loading-text {
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- ローディング -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">読み込み中...</div>
    </div>

    <!-- ログインセクション -->
    <div class="login-section" id="loginSection" style="display: none;">
        <h2>管理画面ログイン</h2>
        <p>記事を投稿・編集するにはログインが必要です</p>
        <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.google.com/favicon.ico" alt="Google">
            Googleでログイン
        </button>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content" id="mainContent">
        <h1>カンゴ☆デラックス - 管理画面</h1>

        <!-- ユーザーバー -->
        <div class="user-bar">
            <div class="user-info">
                <img class="user-avatar" id="userAvatar" src="" alt="">
                <div>
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">ログアウト</button>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">総記事数</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">今日追加</div>
            </div>
        </div>

        <div class="form-section">
            <h2>新規記事登録</h2>
            <form id="newsForm">
                <div class="form-group">
                    <label for="url">URL *</label>
                    <div class="url-input-group">
                        <input type="url" id="url" required placeholder="https://example.com/article">
                        <button type="button" class="btn btn-fetch" id="fetchOgpBtn" onclick="fetchOgp()">
                            OGP取得
                        </button>
                    </div>
                </div>

                <div class="ogp-preview" id="ogpPreview">
                    <div class="ogp-preview-header">取得したプレビュー</div>
                    <div class="ogp-preview-card">
                        <img id="previewImage" class="ogp-preview-image" src="" alt="">
                        <div class="ogp-preview-content">
                            <div class="ogp-preview-title" id="previewTitle"></div>
                            <div class="ogp-preview-description" id="previewDescription"></div>
                            <div class="ogp-preview-site" id="previewSite"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">ひとことコメント（任意）</label>
                    <textarea id="comment" placeholder="この記事についてのコメントや感想"></textarea>
                </div>

                <div class="form-group">
                    <label for="title">タイトル *</label>
                    <input type="text" id="title" required placeholder="記事のタイトル（自動取得されます）">
                </div>

                <div class="form-group">
                    <label for="description">記事の要約</label>
                    <textarea id="description" placeholder="記事の説明（自動取得されます）"></textarea>
                </div>

                <div class="form-group">
                    <label for="image">画像URL</label>
                    <input type="url" id="image" placeholder="https://example.com/image.jpg（自動取得されます）">
                </div>

                <div class="form-group">
                    <label for="category">カテゴリー *</label>
                    <select id="category" required>
                        <option value="">選択してください</option>
                        <option value="digital">デジタル系のニュース</option>
                        <option value="nursing">看護系のニュース</option>
                        <option value="deluxe">デラックスニュース</option>
                        <option value="education">看護教育トピックス</option>
                        <option value="blog">KOKEKUNブログ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="publishedAt">記事公開日</label>
                    <input type="date" id="publishedAt">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="isHero" style="width: 20px; height: 20px;">
                        ヒーロー画面に表示する
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">登録する</button>
            </form>
        </div>

        <h2>登録済み記事一覧</h2>

        <div class="filter-section">
            <label for="filterCategory">カテゴリーで絞り込み: </label>
            <select id="filterCategory">
                <option value="all">すべて</option>
                <option value="digital">デジタル系のニュース</option>
                <option value="nursing">看護系のニュース</option>
                <option value="deluxe">デラックスニュース</option>
                <option value="education">看護教育トピックス</option>
                <option value="blog">KOKEKUNブログ</option>
            </select>
        </div>

        <div class="news-list" id="newsList"></div>
    </div>

    <!-- 編集モーダル -->
    <div id="editModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
            <h2>記事を編集</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="editComment">ひとことコメント</label>
                    <textarea id="editComment"></textarea>
                </div>
                <div class="form-group">
                    <label for="editTitle">タイトル *</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label for="editDescription">記事の要約</label>
                    <textarea id="editDescription"></textarea>
                </div>
                <div class="form-group">
                    <label for="editImage">画像URL</label>
                    <input type="url" id="editImage">
                </div>
                <div class="form-group">
                    <label for="editUrl">URL *</label>
                    <input type="url" id="editUrl" required>
                </div>
                <div class="form-group">
                    <label for="editCategory">カテゴリー *</label>
                    <select id="editCategory" required>
                        <option value="digital">デジタル系のニュース</option>
                        <option value="nursing">看護系のニュース</option>
                        <option value="deluxe">デラックスニュース</option>
                        <option value="education">看護教育トピックス</option>
                        <option value="blog">KOKEKUNブログ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPublishedAt">記事公開日</label>
                    <input type="date" id="editPublishedAt">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="editIsHero" style="width: 20px; height: 20px;">
                        ヒーロー画面に表示する
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">更新する</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCrFGMmKivoNTUWfKglADPw2bWFNaFXgTg",
            authDomain: "kango-dx-news.firebaseapp.com",
            projectId: "kango-dx-news",
            storageBucket: "kango-dx-news.firebasestorage.app",
            messagingSenderId: "888488038184",
            appId: "1:888488038184:web:fa504d57c3f7577ec68a1d"
        };

        // OGP取得用のCloud Functions URL
        const OGP_FUNCTION_URL = "https://us-central1-kango-dx-news.cloudfunctions.net/getOgp";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const categoryNames = {
            'digital': 'デジタル系のニュース',
            'nursing': '看護系のニュース',
            'deluxe': 'デラックスニュース',
            'education': '看護教育トピックス',
            'blog': 'KOKEKUNブログ'
        };

        // ========== 認証関連 ==========

        // Googleログイン
        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('ログイン成功:', result.user.email);
                })
                .catch((error) => {
                    console.error('ログインエラー:', error);
                    alert('ログインに失敗しました: ' + error.message);
                });
        }

        // ログアウト
        function logout() {
            auth.signOut()
                .then(() => {
                    console.log('ログアウトしました');
                })
                .catch((error) => {
                    console.error('ログアウトエラー:', error);
                });
        }

        // 認証状態の監視
        auth.onAuthStateChanged((user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loginSection = document.getElementById('loginSection');
            const mainContent = document.getElementById('mainContent');

            loadingOverlay.classList.add('hide');

            if (user) {
                // ログイン済み
                loginSection.style.display = 'none';
                mainContent.classList.add('show');

                // ユーザー情報を表示
                document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/40';
                document.getElementById('userName').textContent = user.displayName || 'ユーザー';
                document.getElementById('userEmail').textContent = user.email;

                // 記事一覧を読み込み
                loadNews();
            } else {
                // 未ログイン
                loginSection.style.display = 'block';
                mainContent.classList.remove('show');
            }
        });

        // ========== 既存機能 ==========

        // ステータスメッセージ表示
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
            setTimeout(() => {
                statusEl.className = 'status-message';
            }, 3000);
        }

        // OGP取得
        async function fetchOgp() {
            const url = document.getElementById('url').value;
            if (!url) {
                showStatus('URLを入力してください', true);
                return;
            }

            const btn = document.getElementById('fetchOgpBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>取得中...';

            try {
                const response = await fetch(`${OGP_FUNCTION_URL}?url=${encodeURIComponent(url)}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // フォームに反映
                document.getElementById('title').value = data.title || '';
                document.getElementById('description').value = data.description || '';
                document.getElementById('image').value = data.image || '';

                // プレビュー表示
                const preview = document.getElementById('ogpPreview');
                const previewImage = document.getElementById('previewImage');

                if (data.image) {
                    previewImage.src = data.image;
                    previewImage.style.display = 'block';
                } else {
                    previewImage.style.display = 'none';
                }

                document.getElementById('previewTitle').textContent = data.title || '(タイトルなし)';
                document.getElementById('previewDescription').textContent = data.description || '(説明なし)';
                document.getElementById('previewSite').textContent = data.siteName || new URL(url).hostname;

                preview.classList.add('show');
                showStatus('OGP情報を取得しました！');

            } catch (error) {
                console.error('OGP取得エラー:', error);
                showStatus('OGP情報の取得に失敗しました。手動で入力してください。', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'OGP取得';
            }
        }

        // 記事登録フォーム
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                showStatus('ログインしてください', true);
                return;
            }

            const newsData = {
                url: document.getElementById('url').value,
                comment: document.getElementById('comment').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                image: document.getElementById('image').value,
                category: document.getElementById('category').value,
                publishedAt: document.getElementById('publishedAt').value || null,
                isHero: document.getElementById('isHero').checked,
                addedAt: firebase.firestore.FieldValue.serverTimestamp(),
                addedBy: user.email
            };

            try {
                await db.collection('news').add(newsData);
                showStatus('記事を登録しました！');
                document.getElementById('newsForm').reset();
                document.getElementById('ogpPreview').classList.remove('show');
            } catch (error) {
                console.error('Error adding news:', error);
                showStatus('エラーが発生しました: ' + error.message, true);
            }
        });

        // 記事一覧を取得・表示
        function loadNews(filterCategory = 'all') {
            let query = db.collection('news').orderBy('addedAt', 'desc');

            if (filterCategory !== 'all') {
                query = db.collection('news')
                    .where('category', '==', filterCategory)
                    .orderBy('addedAt', 'desc');
            }

            query.onSnapshot((snapshot) => {
                const newsList = document.getElementById('newsList');
                newsList.innerHTML = '';

                let totalCount = 0;
                let todayCount = 0;
                const today = new Date().toDateString();

                snapshot.forEach((doc) => {
                    const news = doc.data();
                    totalCount++;

                    if (news.addedAt && news.addedAt.toDate().toDateString() === today) {
                        todayCount++;
                    }

                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';

                    const addedDate = news.addedAt ? news.addedAt.toDate().toLocaleDateString('ja-JP') : '不明';
                    const imageHtml = news.image
                        ? `<img src="${news.image}" class="news-card-image" alt="" onerror="this.style.display='none'">`
                        : `<div class="news-card-image no-image">No Image</div>`;
                    const commentHtml = news.comment
                        ? `<div class="news-card-comment">${news.comment}</div>`
                        : '';

                    const heroIcon = news.isHero ? '<span style="background:#FFD700;color:#000;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold;margin-right:8px;">HERO</span>' : '';

                    newsItem.innerHTML = `
                        ${commentHtml}
                        <div class="news-card">
                            ${imageHtml}
                            <div class="news-card-content">
                                <div class="news-card-title">
                                    ${heroIcon}<a href="${news.url}" target="_blank">${news.title}</a>
                                </div>
                                <div class="news-card-description">${news.description || ''}</div>
                                <div class="news-meta">
                                    <span class="category-tag category-${news.category}">${categoryNames[news.category] || news.category}</span>
                                    <span>${addedDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="news-actions">
                            <button class="btn btn-edit" onclick="openEditModal('${doc.id}')">編集</button>
                            <button class="btn btn-delete" onclick="deleteNews('${doc.id}')">削除</button>
                        </div>
                    `;
                    newsList.appendChild(newsItem);
                });

                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('todayCount').textContent = todayCount;
            });
        }

        // 記事削除
        async function deleteNews(id) {
            if (confirm('この記事を削除しますか？')) {
                try {
                    await db.collection('news').doc(id).delete();
                    showStatus('記事を削除しました');
                } catch (error) {
                    showStatus('削除に失敗しました: ' + error.message, true);
                }
            }
        }

        // 編集モーダルを開く
        async function openEditModal(id) {
            const doc = await db.collection('news').doc(id).get();
            const news = doc.data();

            document.getElementById('editId').value = id;
            document.getElementById('editComment').value = news.comment || '';
            document.getElementById('editTitle').value = news.title;
            document.getElementById('editDescription').value = news.description || '';
            document.getElementById('editImage').value = news.image || '';
            document.getElementById('editUrl').value = news.url;
            document.getElementById('editCategory').value = news.category;
            document.getElementById('editPublishedAt').value = news.publishedAt || '';
            document.getElementById('editIsHero').checked = news.isHero || false;

            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // 編集フォーム送信
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const newsData = {
                comment: document.getElementById('editComment').value,
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value,
                image: document.getElementById('editImage').value,
                url: document.getElementById('editUrl').value,
                category: document.getElementById('editCategory').value,
                publishedAt: document.getElementById('editPublishedAt').value || null,
                isHero: document.getElementById('editIsHero').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('news').doc(id).update(newsData);
                showStatus('記事を更新しました！');
                closeEditModal();
            } catch (error) {
                showStatus('更新に失敗しました: ' + error.message, true);
            }
        });

        // フィルター変更時
        document.getElementById('filterCategory').addEventListener('change', (e) => {
            loadNews(e.target.value);
        });

        // モーダル外クリックで閉じる
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                closeEditModal();
            }
        });
    </script>
</body>
</html>
